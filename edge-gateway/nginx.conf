# FastGate edge gateway (NGINX 1.25+)
# - Uses auth_request to call the decision service before proxying to origin.
# - Propagates Set-Cookie from the subrequest so the client receives the clearance cookie.
# - Bypasses static asset paths to avoid layout jank.
# - WebSocket-aware for /live (Phoenix LiveView) or similar upgrade endpoints.

worker_processes auto;

events {
  worker_connections 4096;
}

http {
  # Basic, safe defaults
  server_tokens off;
  sendfile on;
  keepalive_timeout 65s;
  client_max_body_size 10m;

  # Identify websocket upgrades
  map $http_upgrade $is_websocket {
    default   0;
    websocket 1;
  }

  # Upstreams
  upstream origin_upstream {
    # Replace with your origin(s); the compose env uses the service name.
    server origin:8081;
    keepalive 64;
  }
  upstream fastgate_decision {
    server decision:8080;
    keepalive 64;
  }

  server {
    listen 8080;
    server_name _;

    # === Internal subrequest to Decision Service ===========================
    # Returns:
    #  - 204 => allow
    #  - 401 => challenge (we rewrite to /__uam)
    #  - 403 => block
    location = /__fastgate_auth {
      internal;
      proxy_pass http://fastgate_decision/v1/authz;

      # No body on subrequest
      proxy_pass_request_body off;
      proxy_set_header Content-Length "";

      # Forward metadata used by the decision service
      proxy_set_header X-Original-Method $request_method;
      proxy_set_header X-Original-URI    $request_uri;
      proxy_set_header X-Original-Host   $host;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header X-Client-IP       $remote_addr;
      proxy_set_header X-WS-Upgrade      $http_upgrade;
      proxy_set_header User-Agent        $http_user_agent;
      proxy_set_header Accept-Language   $http_accept_language;
      proxy_set_header Cookie            $http_cookie;

      # Keep TLS/Host semantics for same-origin decisions
      proxy_set_header Host $host;
      proxy_http_version 1.1;
      proxy_set_header Connection "";
    }

    # Capture Set-Cookie from the auth subrequest and add it to the parent response.
    # (Decision service currently issues at most one Set-Cookie per call.)
    auth_request_set $fastgate_set_cookie $upstream_http_set_cookie;

    # Map 401/403 (from auth subrequest) to challenge/block handlers.
    error_page 401 = @fastgate_challenge;
    error_page 403 = @fastgate_block;

    # === Challenge handler =================================================
    location @fastgate_challenge {
      if ($fastgate_set_cookie) {
        add_header Set-Cookie $fastgate_set_cookie always;
      }
      # Redirect the client to the tiny challenge page with original URL in ?u=
      return 302 /__uam?u=$request_uri;
    }

    # === Block handler =====================================================
    location @fastgate_block {
      default_type text/plain;
      return 403 "Forbidden\n";
    }

    # === Static challenge page (unguarded) ================================
    location = /__uam {
      root /usr/share/nginx/html;
      add_header Cache-Control "no-store";
      try_files /index.html =404;
    }

    # === Decision service API proxy (same-origin for fetch) ===============
    # Keep this unguarded so the page can call /v1/challenge/* without recursion.
    location /v1/ {
      proxy_pass http://fastgate_decision;
      proxy_http_version 1.1;
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      add_header Cache-Control "no-store";
    }

    # === BYPASS: common static paths (no gating to avoid layout jank) =====
    # Adjust or remove these if you prefer to gate every request.
    location ~* ^/(assets|static|_next|favicon\.ico|robots\.txt) {
      proxy_pass http://origin_upstream;
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # === WebSocket endpoint (e.g., Phoenix LiveView at /live) =============
    # Gate on the HTTP upgrade; only allow if auth_request returns 204.
    location /live {
      auth_request /__fastgate_auth;

      # Propagate clearance cookie from subrequest, if any
      if ($fastgate_set_cookie) { add_header Set-Cookie $fastgate_set_cookie always; }

      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection "upgrade";
      proxy_http_version 1.1;
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_read_timeout 65s;  # Allow idle pings

      proxy_pass http://origin_upstream;
    }

    # === Default: gate all other routes ===================================
    location / {
      auth_request /__fastgate_auth;

      # Propagate clearance cookie from subrequest, if any
      if ($fastgate_set_cookie) { add_header Set-Cookie $fastgate_set_cookie always; }

      proxy_http_version 1.1;
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

      proxy_pass http://origin_upstream;
    }
  }
}
